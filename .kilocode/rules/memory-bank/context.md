# FlowDash - Context

## ðŸŽ¯ **Current Work Focus**
The application has undergone comprehensive bug fixes and improvements, addressing both filtering functionality and API validation issues. Recent work has focused on resolving 400 Bad Request errors in user management operations while maintaining security best practices.

## ðŸ”„ **Recent Changes**
- **Fixed 400 Bad Request Error in User Management**: Resolved a critical issue where updating user names in the user management page was failing with a 400 error. The problem was caused by the client sending an `id` field in the request body that the API's Zod schema rejected due to `.strict()` validation. Modified the `useCrud` hook to exclude the `id` from the request body, following REST API best practices where the resource ID is provided in the URL path. Also fixed an ESLint warning for unused variables.
- **Fixed Inventory Log Filters**: Resolved multiple bugs in the inventory logs page. The general search and "Filter by user" functionalities are now working correctly. The API endpoint at `src/app/api/inventory/logs/route.ts` was fixed to properly apply `search` and `userId` query parameters.
- **Fixed Product Search Filter**: Corrected the search functionality on the product management page. The API endpoint at `src/app/api/products/route.ts` now properly filters products by name.
- **Improved Inventory Log Search UX**: Changed the search behavior on the inventory logs page. The search is no longer triggered on every keystroke but only when the "Filter" button is clicked, providing a more controlled user experience.
- **Enhanced "Filter by user" on Inventory Logs**:
    - The filter now correctly sends the `userId` instead of the username to the API.
    - The dropdown now exclusively lists users with the `floor_staff` role.
    - The filter now includes both active and inactive floor staff to allow searching of historical logs.
    - The dropdown displays the user's full name instead of their username for better readability.
- **Fixed Critical Race Condition**: Resolved a complex client-side race condition between Next.js App Router parameter hydration, `AuthContext` initialization, and `i18next` language loading. This fix stabilized the application on page refresh.
- **Eliminated Infinite API Loop**: By fixing the underlying i18n and authentication race condition, the infinite API call loop that was occurring on all authenticated pages has been eliminated.
- **Corrected URL Generation**: Fixed a bug where navigation links would be generated with `/undefined/...` in the URL path on page refresh. The fix ensures the language parameter (`lng`) is correctly passed from the page `params` to the layout components.
- **Stabilized Translations**: Ensured that translations load correctly and reliably on page refresh by synchronizing the `i18next` instance with the language parameter from the URL.
- **Centralized Loading State**: Refactored the initial application loading logic into the `AppInitializer` component to prevent multiple components from managing competing loading states, which was the original source of the "white blank screen" bug.
- **Added Loading Feedback**: Implemented loading state feedback on the login and logout buttons for a better user experience.
- **Code Cleanup**: Removed all debugging `console.log` statements from the codebase.
- **Linting**: Fixed all linting errors and warnings, ensuring a clean and maintainable codebase.
- **Translation System Fixes**: Resolved critical namespace loading issues that were causing toast messages to display raw translation keys instead of translated text. Restructured translation keys for better organization and fixed all product-related toast messages.
- **Translation File Structure Optimization**: Implemented a categorized file structure for translations to improve maintainability and team collaboration.
- **Toast Message System Refactor**: Completely refactored the toast message system to eliminate hardcoded translations in the generic useCrud hook. Implemented a flexible messaging system where each component provides its own localized messages based on domain context. This ensures UserManager shows "User" messages, ProductAttributesManager shows "Attribute" messages, and InventoryLogs shows "Log" messages, all properly translated across English, Hindi, and Gujarati languages.
- **Button Color Scheme Fix**: Identified and resolved a critical theme configuration issue where custom Button variants were overriding Chakra UI's built-in colorScheme functionality. The custom `solid` variant in `src/theme/theme.ts` was hardcoding all buttons to use `brand.primary` (blue) background, completely bypassing `colorScheme="red"`, `colorScheme="green"`, etc. props. Removed the problematic custom variants while preserving the baseStyle for consistent button appearance (fontWeight, borderRadius, boxShadow, responsive padding).
- **Enhanced User Experience**: All buttons now display appropriate colors based on their action types: red for destructive actions (delete, archive, logout), green for positive actions (save, reactivate), blue for primary actions (login, add, update), and default gray for neutral actions (edit, cancel). This provides clear visual feedback that helps factory workers understand the impact of their actions.
- **Login Attempt Tracking Enhancement**: Implemented comprehensive login attempt tracking with user-specific counters. Users now see remaining login attempts (9, 8, 7...) for invalid credentials, while inactive accounts don't display attempt counters for security. Fixed critical bug where different users from same IP were sharing attempt counters by implementing IP + username composite keys for rate limiting.
- **Improved Login Error Messages**: Enhanced error handling with structured error codes and localized messages. Added support for different error types (RATE_LIMIT_EXCEEDED, ACCOUNT_INACTIVE, INVALID_CREDENTIALS) with appropriate user feedback and remaining attempt display.
- **Translation System Enhancement**: Added new translation keys for login error messages across all supported languages (English, Hindi, Gujarati) with dynamic variable interpolation for remaining attempts and reset times.
- **Code Quality Improvements**: Fixed linting warnings, removed unused imports, and ensured clean, maintainable codebase with proper TypeScript types and error handling.
- **Fixed Login Error Notices**: Resolved inconsistency between local and Vercel deployment where login error notices were not displaying correctly on Vercel. Modified `src/lib/errors.ts` to always include error details for client errors (4xx status codes) in both development and production environments, ensuring consistent error messaging across all deployment targets.
- **Version Update**: Updated application version from 0.2.0 to 0.2.1 to reflect the bug fix release.
- **README Cleanup**: Removed the Project Structure section from README.md for cleaner documentation.
- **CI/CD Workflow Enhancement**: Updated GitHub Actions workflow to include comprehensive testing and build verification. Added `test` and `build` jobs to ensure code quality across all branches. Expanded workflow triggers to run on all pushes and pull requests, providing CI coverage for the entire development process.
- **Jest Configuration Fix**: Fixed Jest configuration to properly ignore Playwright E2E tests by adding `testPathIgnorePatterns` for the `tests/` directory, preventing test execution conflicts between unit and E2E test frameworks.
- **Login Component Test Fixes**: Resolved test failures by removing incorrect mocks for non-existent `LanguageContext`, adding required `lng` prop, and implementing proper mocks for `next/navigation` router to ensure reliable unit testing.

## ðŸš€ **Next Steps**
The application is now in a stable state with key filtering functionalities fixed, API validation issues resolved, and improved CI/CD pipeline. The codebase is clean with no linting errors, comprehensive test coverage, and automated build verification. Future work will proceed based on the project roadmap.